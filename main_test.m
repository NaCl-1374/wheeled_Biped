clear;
clear all;



%% %仿真参数
runtime=10;%仿真时长
delta_t = 0.0005;%仿真时间间隔
ControlHz=1000;
IterControlRate=fix(1/ControlHz/delta_t);%mpc频率控制
t=0:delta_t:runtime-delta_t;

%% 
%仿真循环
State_X=zeros(6,1);
State_X(1)=0;
State_X(5)=0.2;

log_x=[];
log_U=[];


%%

Robot.R=0.1/2;
Robot.L =0.35/2;  %摆杆重心到驱动轮轴距离
Robot.LM =0.35/2; %摆杆重心到机体转轴距离
Robot.l =0.05;  %机体重心到机体转轴距离
Robot.mw =2;   %转子质量
Robot.mp =0.4;   %摆杆质量
Robot.M=10;    %机体质量
Robot.Iw =0.5*Robot.mw*(Robot.R^2+(Robot.R-0.03)^2);%转子惯量
Robot.Ip =1/4*Robot.mp*0.08^2+1/12*Robot.mp*Robot.L^2;%摆杆惯量
Robot.IM =1/4*Robot.M*0.3^2+1/12*Robot.M*0.3^2;%机体惯量
Robot.g =9.8;


%%
Q=diag([1,1,1000,100,5000,1]);
R=diag([50,10]);
[K,Kc]=calculate_LQR2(Robot,Q,R);
U=[0,0]';
%%
for iter = 1:runtime/delta_t
    %控制器频率控制
    
    if rem(iter,IterControlRate)==0
    U = control_LQR(State_X,K);
    end
    log_x=[log_x,State_X];
    log_U=[log_U,U];

    State_X=State_X+sfuntmpl(State_X,U,Robot)*delta_t;
    
    
end
subplot(2,2,1)
plot(t,log_x(1,:),'r')
hold on
plot(t,log_x(2,:),'g')
legend('th','dth')
title('theta')
subplot(2,2,2)
plot(t,log_x(3,:),'g')
hold on
plot(t,log_x(4,:),'r')
legend('x','dx')
title('X')
subplot(2,2,3)
plot(t,log_x(5,:),'b')
hold on
plot(t,log_x(6,:),'r')
legend('fai','dfai')
title('fai')
subplot(2,2,4)
plot(log_U(1,:),'b')
hold on
plot(log_U(2,:),'r')
legend('T轮子','T大腿')
title('U')


function DX=sfuntmpl(X,U,Robot)

R=Robot.R;
L =Robot.L;
L_M =Robot.LM;
l =Robot.l;
m_w =Robot.mw;
m_p =Robot.mp;
M=Robot.M;
I_w =Robot.Iw;
I_p =Robot.Ip;
I_M =Robot.IM;
g =Robot.g;

thetaa=X(1);
theta_dota=X(2);
xa=X(3);
x_dota=X(4);
phia=X(5);
phi_dota=X(6);
T=U(1);
T_p=U(2);


%%
ddth=-(I_M*I_w*T - I_M*I_w*T_p + I_M*R^2*T*m_p + I_M*R^2*T*m_w - I_M*R^2*T_p*m_p - I_M*R^2*T_p*m_w + I_M*M*R^2*T - I_M*M*R^2*T_p - M^2*R^2*T*l^2*sin(phia)^2 + M^2*R^2*T_p*l^2*sin(phia)^2 + I_w*M*T*l^2*cos(phia)^2 - I_w*M*T_p*l^2*cos(phia)^2 - I_w*M*T*l^2*sin(phia)^2 + I_w*M*T_p*l^2*sin(phia)^2 + M*R^2*T*l^2*m_p*cos(phia)^2 + M*R^2*T*l^2*m_w*cos(phia)^2 - M*R^2*T_p*l^2*m_p*cos(phia)^2 - M*R^2*T_p*l^2*m_w*cos(phia)^2 - M*R^2*T*l^2*m_p*sin(phia)^2 - M*R^2*T*l^2*m_w*sin(phia)^2 + M*R^2*T_p*l^2*m_p*sin(phia)^2 + M*R^2*T_p*l^2*m_w*sin(phia)^2 ...
    - I_M*L*M^2*R^2*g*sin(thetaa) - I_M*L_M*M^2*R^2*g*sin(thetaa) + I_M*L*M*R*T*cos(thetaa) + I_M*L_M*M*R*T*cos(thetaa) - I_M*L*R^2*g*m_p^2*sin(thetaa) - I_M*I_w*L*M*g*sin(thetaa) - I_M*I_w*L_M*M*g*sin(thetaa) + I_M*L*R*T*m_p*cos(thetaa) - I_M*I_w*L*g*m_p*sin(thetaa) + I_M*L^2*M^2*R^2*theta_dota^2*cos(thetaa)*sin(thetaa) + I_M*L_M^2*M^2*R^2*theta_dota^2*cos(thetaa)*sin(thetaa) + I_w*L*M^2*l^3*phi_dota^2*cos(thetaa)*sin(phia)^3 + I_w*L*M^2*l^3*phi_dota^2*cos(phia)^3*sin(thetaa) + I_w*L_M*M^2*l^3*phi_dota^2*cos(thetaa)*sin(phia)^3 + ...
    I_w*L_M*M^2*l^3*phi_dota^2*cos(phia)^3*sin(thetaa) + I_M*L^2*R^2*m_p^2*theta_dota^2*cos(thetaa)*sin(thetaa) + L*M^2*R^2*T_p*l*sin(phia)*sin(thetaa) + L_M*M^2*R^2*T_p*l*sin(phia)*sin(thetaa) + I_w*L*M*T_p*l*cos(phia)*cos(thetaa) + I_w*L_M*M*T_p*l*cos(phia)*cos(thetaa) - 2*I_M*L*M*R^2*g*m_p*sin(thetaa) - I_M*L*M*R^2*g*m_w*sin(thetaa) - I_M*L_M*M*R^2*g*m_p*sin(thetaa) - I_M*L_M*M*R^2*g*m_w*sin(thetaa) + I_w*L*M*T_p*l*sin(phia)*sin(thetaa) + I_w*L_M*M*T_p*l*sin(phia)*sin(thetaa) - I_M*L*R^2*g*m_p*m_w*sin(thetaa) - L*M^2*R*T*l^2*cos(thetaa)*sin(phia)^2 ...
    - L_M*M^2*R*T*l^2*cos(thetaa)*sin(phia)^2 - I_w*L*M^2*g*l^2*cos(phia)^2*sin(thetaa) - I_w*L_M*M^2*g*l^2*cos(phia)^2*sin(thetaa) + I_w*L*M*g*l^2*m_p*sin(phia)^2*sin(thetaa) + I_w*L*M^2*l^3*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(phia) + I_w*L_M*M^2*l^3*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(phia) + L*M^2*R^2*l^3*m_p*phi_dota^2*cos(phia)^3*sin(thetaa) + L*M^2*R^2*l^3*m_w*phi_dota^2*cos(thetaa)*sin(phia)^3 + L*M^2*R^2*l^3*m_w*phi_dota^2*cos(phia)^3*sin(thetaa) + L_M*M^2*R^2*l^3*m_p*phi_dota^2*cos(thetaa)*sin(phia)^3 + L_M*M^2*R^2*l^3*m_p*phi_dota^2*cos(phia)^3*sin(thetaa)...
    + L_M*M^2*R^2*l^3*m_w*phi_dota^2*cos(thetaa)*sin(phia)^3 + L_M*M^2*R^2*l^3*m_w*phi_dota^2*cos(phia)^3*sin(thetaa) + 2*I_M*L*L_M*M^2*R^2*theta_dota^2*cos(thetaa)*sin(thetaa) + I_w*L*M^2*l^3*phi_dota^2*cos(phia)*sin(phia)^2*sin(thetaa) + I_w*L_M*M^2*l^3*phi_dota^2*cos(phia)*sin(phia)^2*sin(thetaa) + I_M*L*M^2*R^2*l*phi_dota^2*cos(phia)*sin(thetaa) + I_M*L_M*M^2*R^2*l*phi_dota^2*cos(phia)*sin(thetaa) + 2*I_M*L^2*M*R^2*m_p*theta_dota^2*cos(thetaa)*sin(thetaa) - I_w*L*M^2*g*l^2*cos(phia)*cos(thetaa)*sin(phia) - I_w*L_M*M^2*g*l^2*cos(phia)*cos(thetaa)*sin(phia) - L*M^2*R*T*l^2*cos(phia)*sin(phia)*sin(thetaa)...
    - L_M*M^2*R*T*l^2*cos(phia)*sin(phia)*sin(thetaa) + I_M*I_w*L*M*l*phi_dota^2*cos(phia)*sin(thetaa) - I_M*I_w*L*M*l*phi_dota^2*cos(thetaa)*sin(phia) + I_M*I_w*L_M*M*l*phi_dota^2*cos(phia)*sin(thetaa) - I_M*I_w*L_M*M*l*phi_dota^2*cos(thetaa)*sin(phia) + L*M*R^2*T_p*l*m_w*cos(phia)*cos(thetaa) + L_M*M*R^2*T_p*l*m_p*cos(phia)*cos(thetaa) + L_M*M*R^2*T_p*l*m_w*cos(phia)*cos(thetaa) + I_w*L^2*M^2*l^2*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + I_w*L_M^2*M^2*l^2*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + I_w*L^2*M^2*l^2*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) +...
    I_w*L_M^2*M^2*l^2*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + I_w*L^2*M^2*l^2*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + I_w*L_M^2*M^2*l^2*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + I_w*L^2*M^2*l^2*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L*M*R^2*T_p*l*m_p*sin(phia)*sin(thetaa) + L*M*R^2*T_p*l*m_w*sin(phia)*sin(thetaa) + I_w*L_M^2*M^2*l^2*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L_M*M*R^2*T_p*l*m_p*sin(phia)*sin(thetaa) + L_M*M*R^2*T_p*l*m_w*sin(phia)*sin(thetaa) - L*M*R^2*g*l^2*m_p^2*cos(phia)^2*sin(thetaa) - L*M^2*R^2*g*l^2*m_p*cos(phia)^2*sin(thetaa)...
    - L*M^2*R^2*g*l^2*m_w*cos(phia)^2*sin(thetaa) - L_M*M^2*R^2*g*l^2*m_p*cos(phia)^2*sin(thetaa) - L_M*M^2*R^2*g*l^2*m_w*cos(phia)^2*sin(thetaa) + L*M*R^2*g*l^2*m_p^2*sin(phia)^2*sin(thetaa) + L*M^2*R^2*g*l^2*m_p*sin(phia)^2*sin(thetaa) + L*M*R*T*l^2*m_p*cos(phia)^2*cos(thetaa) - L*M*R*T*l^2*m_p*cos(thetaa)*sin(phia)^2 - I_w*L*M*g*l^2*m_p*cos(phia)^2*sin(thetaa) + L*M^2*R^2*l^3*m_w*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(phia) + L_M*M^2*R^2*l^3*m_p*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(phia) + L_M*M^2*R^2*l^3*m_w*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(phia) + L*M^2*R^2*l^3*m_p*phi_dota^2*cos(phia)*sin(phia)^2*sin(thetaa)...
    + L*M^2*R^2*l^3*m_w*phi_dota^2*cos(phia)*sin(phia)^2*sin(thetaa) + L_M*M^2*R^2*l^3*m_p*phi_dota^2*cos(phia)*sin(phia)^2*sin(thetaa) + L_M*M^2*R^2*l^3*m_w*phi_dota^2*cos(phia)*sin(phia)^2*sin(thetaa) - L*M^2*R^2*g*l^2*m_w*cos(phia)*cos(thetaa)*sin(phia) - L_M*M^2*R^2*g*l^2*m_p*cos(phia)*cos(thetaa)*sin(phia) - L_M*M^2*R^2*g*l^2*m_w*cos(phia)*cos(thetaa)*sin(phia) + 2*I_M*L*L_M*M*R^2*m_p*theta_dota^2*cos(thetaa)*sin(thetaa) + I_M*L*M*R^2*l*m_p*phi_dota^2*cos(phia)*sin(thetaa) + I_M*L*M*R^2*l*m_w*phi_dota^2*cos(phia)*sin(thetaa) - I_M*L*M*R^2*l*m_w*phi_dota^2*cos(thetaa)*sin(phia) + I_M*L_M*M*R^2*l*m_p*phi_dota^2*cos(phia)*sin(thetaa)...
    - I_M*L_M*M*R^2*l*m_p*phi_dota^2*cos(thetaa)*sin(phia) + I_M*L_M*M*R^2*l*m_w*phi_dota^2*cos(phia)*sin(thetaa) - I_M*L_M*M*R^2*l*m_w*phi_dota^2*cos(thetaa)*sin(phia) + L^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L_M^2*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L_M^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L^2*M*R^2*l^2*m_p^2*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + L^2*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + L^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa)...
    + L_M^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + L^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L_M^2*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L_M^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 - L^2*M*R^2*l^2*m_p^2*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) - L^2*M^2*R^2*l^2*m_p*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_p*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_w*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa)...
    + 2*I_w*L*L_M*M^2*l^2*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + 2*I_w*L*L_M*M^2*l^2*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + 2*I_w*L*L_M*M^2*l^2*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + 2*I_w*L*L_M*M^2*l^2*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) - L*M*R^2*g*l^2*m_p*m_w*cos(phia)^2*sin(thetaa) + L*M*R^2*g*l^2*m_p*m_w*sin(phia)^2*sin(thetaa) + L*L_M*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + 2*L*L_M*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + 2*L*L_M*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + 2*L*L_M*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa)...
    + L*L_M*M^2*R^2*l^2*m_p*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_w*theta_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_w*theta_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa))/(I_M*I_p*I_w + I_M*I_p*R^2*m_p + I_M*I_p*R^2*m_w + I_M*I_p*M*R^2 - I_p*M^2*R^2*l^2*sin(phia)^2 + I_M*L^2*R^2*m_p^2*sin(thetaa)^2 + I_M*I_w*L^2*M*cos(thetaa)^2 + I_M*I_w*L_M^2*M*cos(thetaa)^2 + I_M*I_w*L^2*M*sin(thetaa)^2 + I_M*I_w*L_M^2*M*sin(thetaa)^2 + I_p*I_w*M*l^2*cos(phia)^2 + I_M*I_w*L^2*m_p*cos(thetaa)^2 - I_p*I_w*M*l^2*sin(phia)^2 + I_M*I_w*L^2*m_p*sin(thetaa)^2 + I_M*L^2*M^2*R^2*sin(thetaa)^2 + I_M*L_M^2*M^2*R^2*sin(thetaa)^2 + 2*I_M*L^2*M*R^2*m_p*sin(thetaa)^2 ...
    + I_M*L^2*M*R^2*m_w*sin(thetaa)^2 + I_M*L_M^2*M*R^2*m_p*sin(thetaa)^2 + I_M*L_M^2*M*R^2*m_w*sin(thetaa)^2 + 2*I_M*I_w*L*L_M*M*cos(thetaa)^2 + I_p*M*R^2*l^2*m_p*cos(phia)^2 + I_p*M*R^2*l^2*m_w*cos(phia)^2 + I_M*L^2*R^2*m_p*m_w*cos(thetaa)^2 + 2*I_M*I_w*L*L_M*M*sin(thetaa)^2 - I_p*M*R^2*l^2*m_p*sin(phia)^2 - I_p*M*R^2*l^2*m_w*sin(phia)^2 + I_M*L^2*R^2*m_p*m_w*sin(thetaa)^2 + I_w*L^2*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - I_w*L^2*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + I_w*L_M^2*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - I_w*L_M^2*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + 2*I_M*L*L_M*M^2*R^2*sin(thetaa)^2 + I_M*L^2*M*R^2*m_w*cos(thetaa)^2 + I_M*L_M^2*M*R^2*m_p*cos(thetaa)^2 + I_M*L_M^2*M*R^2*m_w*cos(thetaa)^2 ...
    + L^2*M*R^2*l^2*m_p^2*cos(phia)^2*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - L^2*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*R^2*l^2*m_p*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 - L^2*M*R^2*l^2*m_p^2*sin(phia)^2*sin(thetaa)^2 - L^2*M^2*R^2*l^2*m_p*sin(phia)^2*sin(thetaa)^2 + 2*I_w*L*L_M*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - 2*I_w*L*L_M*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + I_w*L^2*M*l^2*m_p*cos(phia)^2*cos(thetaa)^2 + I_w*L^2*M*l^2*m_p*cos(phia)^2*sin(thetaa)^2 - ...
    I_w*L^2*M*l^2*m_p*cos(thetaa)^2*sin(phia)^2 - I_w*L^2*M*l^2*m_p*sin(phia)^2*sin(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_w*cos(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_p*sin(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_w*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - 2*L*L_M*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 + L^2*M*R^2*l^2*m_p*m_w*cos(phia)^2*cos(thetaa)^2 + L^2*M*R^2*l^2*m_p*m_w*cos(phia)^2*sin(thetaa)^2 - L^2*M*R^2*l^2*m_p*m_w*cos(thetaa)^2*sin(phia)^2 - L^2*M*R^2*l^2*m_p*m_w*sin(phia)^2*sin(thetaa)^2);
%%
ddx=(R*(I_M*I_p*T + I_M*L^2*M*T*cos(thetaa)^2 + I_M*L_M^2*M*T*cos(thetaa)^2 + I_M*L^2*M*T*sin(thetaa)^2 + I_M*L_M^2*M*T*sin(thetaa)^2 + I_p*M*T*l^2*cos(phia)^2 + I_M*L^2*T*m_p*cos(thetaa)^2 - I_p*M*T*l^2*sin(phia)^2 + I_M*L^2*T*m_p*sin(thetaa)^2 + 2*I_M*L*L_M*M*T*cos(thetaa)^2 + 2*I_M*L*L_M*M*T*sin(thetaa)^2 + L^2*M^2*T*l^2*cos(phia)^2*sin(thetaa)^2 - L^2*M^2*T*l^2*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*T*l^2*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*T*l^2*cos(thetaa)^2*sin(phia)^2 + I_M*L^3*M^2*R*theta_dota^2*sin(thetaa)^3 + I_M*L_M^3*M^2*R*theta_dota^2*sin(thetaa)^3 ...
    - I_p*M^2*R*l^3*phi_dota^2*sin(phia)^3 + I_M*L^3*R*m_p^2*theta_dota^2*sin(thetaa)^3 + I_M*L*M*R*T*cos(thetaa) + I_M*L_M*M*R*T*cos(thetaa) - I_M*L*M*R*T_p*cos(thetaa) - I_M*L_M*M*R*T_p*cos(thetaa) - I_p*M*R*T_p*l*cos(phia)...
    + I_M*L*R*T*m_p*cos(thetaa) - I_M*L*R*T_p*m_p*cos(thetaa) ...
    + 2*L*L_M*M^2*T*l^2*cos(phia)^2*sin(thetaa)^2 - 2*L*L_M*M^2*T*l^2*cos(thetaa)^2*sin(phia)^2 +...
    I_M*L^3*M^2*R*theta_dota^2*cos(thetaa)^2*sin(thetaa) + I_M*L_M^3*M^2*R*theta_dota^2*cos(thetaa)^2*sin(thetaa) + L^2*M*T*l^2*m_p*cos(phia)^2*cos(thetaa)^2 ...
    - I_p*M^2*R*l^3*phi_dota^2*cos(phia)^2*sin(phia) + L^2*M*T*l^2*m_p*cos(phia)^2*sin(thetaa)^2 ...
- L^2*M*T*l^2*m_p*cos(thetaa)^2*sin(phia)^2 + I_M*L^3*R*m_p^2*theta_dota^2*cos(thetaa)^2*sin(thetaa)...
    - L^2*M*T*l^2*m_p*sin(phia)^2*sin(thetaa)^2 - I_M*L^2*M^2*R*g*cos(thetaa)*sin(thetaa) -...
    I_M*L_M^2*M^2*R*g*cos(thetaa)*sin(thetaa) + 2*I_M*L^3*M*R*m_p*theta_dota^2*sin(thetaa)^3 +...
    I_p*M^2*R*g*l^2*cos(phia)*sin(phia) + I_M*I_p*L*M*R*theta_dota^2*sin(thetaa) + ...
    I_M*I_p*L_M*M*R*theta_dota^2*sin(thetaa) - I_M*L^2*R*g*m_p^2*cos(thetaa)*sin(thetaa) +...
    I_M*I_p*M*R*l*phi_dota^2*sin(phia) + I_M*I_p*L*R*m_p*theta_dota^2*sin(thetaa) +...
    3*I_M*L*L_M^2*M^2*R*theta_dota^2*sin(thetaa)^3 + 3*I_M*L^2*L_M*M^2*R*theta_dota^2*sin(thetaa)^3 ...
    - L*M^2*R*T*l^2*cos(thetaa)*sin(phia)^2 - L_M*M^2*R*T*l^2*cos(thetaa)*sin(phia)^2 +...
    L*M^2*R*T_p*l^2*cos(thetaa)*sin(phia)^2 - L^2*M^2*R*T_p*l*cos(phia)*sin(thetaa)^2 +...
    L_M*M^2*R*T_p*l^2*cos(thetaa)*sin(phia)^2 - L_M^2*M^2*R*T_p*l*cos(phia)*sin(thetaa)^2 +...
    2*I_M*L^3*M*R*m_p*theta_dota^2*cos(thetaa)^2*sin(thetaa) - ...
    2*I_M*L*L_M*M^2*R*g*cos(thetaa)*sin(thetaa) + L*M^2*R*T*l^2*cos(phia)*sin(phia)*sin(thetaa) + ...
    L_M*M^2*R*T*l^2*cos(phia)*sin(phia)*sin(thetaa) - L*M^2*R*T_p*l^2*cos(phia)*sin(phia)*sin(thetaa) ...
    - L_M*M^2*R*T_p*l^2*cos(phia)*sin(phia)*sin(thetaa) + L^2*M^2*R*T_p*l*cos(thetaa)*sin(phia)*sin(thetaa) ...
    + L_M^2*M^2*R*T_p*l*cos(thetaa)*sin(phia)*sin(thetaa) - 2*I_M*L^2*M*R*g*m_p*cos(thetaa)*sin(thetaa) + ...
    L^3*M*R*l^2*m_p^2*theta_dota^2*cos(phia)^2*sin(thetaa)^3 + L^3*M^2*R*l^2*m_p*theta_dota^2*cos(phia)^2*sin(thetaa)^3 + ...
    3*I_M*L*L_M^2*M^2*R*theta_dota^2*cos(thetaa)^2*sin(thetaa) + 3*I_M*L^2*L_M*M^2*R*theta_dota^2*cos(thetaa)^2*sin(thetaa)...
    - L^2*M^2*R*l^3*m_p*phi_dota^2*sin(phia)^3*sin(thetaa)^2 - L^3*M*R*l^2*m_p^2*theta_dota^2*sin(phia)^2*sin(thetaa)^3 ...
    - L^3*M^2*R*l^2*m_p*theta_dota^2*sin(phia)^2*sin(thetaa)^3 + I_M*L^2*M^2*R*l*phi_dota^2*sin(phia)*sin(thetaa)^2 + ...
    I_M*L_M^2*M^2*R*l*phi_dota^2*sin(phia)*sin(thetaa)^2 - I_p*L*M^2*R*l^2*theta_dota^2*sin(phia)^2*sin(thetaa) - ...
    I_p*L_M*M^2*R*l^2*theta_dota^2*sin(phia)^2*sin(thetaa) + I_M*L*L_M^2*M*R*m_p*theta_dota^2*sin(thetaa)^3 + 3*I_M*L^2*L_M*M*R*m_p*theta_dota^2*sin(thetaa)^3 - 2*L*L_M*M^2*R*T_p*l*cos(phia)*sin(thetaa)^2 + L*M*R*T*l^2*m_p*cos(phia)^2*cos(thetaa) - L*M*R*T_p*l^2*m_p*cos(phia)^2*cos(thetaa) - L*M*R*T*l^2*m_p*cos(thetaa)*sin(phia)^2 + L*M*R*T_p*l^2*m_p*cos(thetaa)*sin(phia)^2 - L^2*M*R*T_p*l*m_p*cos(phia)*sin(thetaa)^2 + L^2*M^2*R*l^3*m_p*phi_dota^2*cos(phia)^3*cos(thetaa)*sin(thetaa) + I_M*L^2*M^2*R*l*phi_dota^2*cos(phia)*cos(thetaa)*sin(thetaa) - I_p*L*M^2*R*l^2*theta_dota^2*cos(phia)*cos(thetaa)*sin(phia) + I_M*L_M^2*M^2*R*l*phi_dota^2*cos(phia)*cos(thetaa)*sin(thetaa) - I_p*L_M*M^2*R*l^2*theta_dota^2*cos(phia)*cos(thetaa)*sin(phia) + 2*L*L_M*M^2*R*T_p*l*cos(thetaa)*sin(phia)*sin(thetaa) + L^3*M*R*l^2*m_p^2*theta_dota^2*cos(phia)^2*cos(thetaa)^2*sin(thetaa) + L^3*M^2*R*l^2*m_p*theta_dota^2*cos(phia)^2*cos(thetaa)^2*sin(thetaa) - L^2*M^2*R*l^3*m_p*phi_dota^2*cos(phia)^2*sin(phia)*sin(thetaa)^2 - 2*I_M*L*L_M*M*R*g*m_p*cos(thetaa)*sin(thetaa) - L^3*M*R*l^2*m_p^2*theta_dota^2*cos(thetaa)^2*sin(phia)^2*sin(thetaa) - L^3*M^2*R*l^2*m_p*theta_dota^2*cos(thetaa)^2*sin(phia)^2*sin(thetaa) + L*L_M*M^2*R*l^3*m_p*phi_dota^2*cos(thetaa)^2*sin(phia)^3 + L^2*M*R*T_p*l*m_p*cos(thetaa)*sin(phia)*sin(thetaa) - L^2*M*R*g*l^2*m_p^2*cos(phia)^2*cos(thetaa)*sin(thetaa) - L^2*M^2*R*g*l^2*m_p*cos(phia)^2*cos(thetaa)*sin(thetaa) + I_M*L*L_M^2*M*R*m_p*theta_dota^2*cos(thetaa)^2*sin(thetaa) + 3*I_M*L^2*L_M*M*R*m_p*theta_dota^2*cos(thetaa)^2*sin(thetaa) + 2*I_M*L*L_M*M^2*R*l*phi_dota^2*sin(phia)*sin(thetaa)^2 + L^2*M*R*g*l^2*m_p^2*cos(thetaa)*sin(phia)^2*sin(thetaa)...
    + L^2*M^2*R*g*l^2*m_p*cos(thetaa)*sin(phia)^2*sin(thetaa) + I_p*L*M*R*l^2*m_p*theta_dota^2*cos(phia)^2*sin(thetaa) + I_M*L^2*M*R*l*m_p*phi_dota^2*sin(phia)*sin(thetaa)^2 - I_p*L*M*R*l^2*m_p*theta_dota^2*sin(phia)^2*sin(thetaa) + L*L_M*M*R*T_p*l*m_p*cos(phia)*cos(thetaa)^2 + L*L_M^2*M^2*R*l^2*m_p*theta_dota^2*cos(phia)^2*sin(thetaa)^3 + 2*L^2*L_M*M^2*R*l^2*m_p*theta_dota^2*cos(phia)^2*sin(thetaa)^3 - L^2*L_M*M^2*R*l^2*m_p*theta_dota^2*sin(phia)^2*sin(thetaa)^3 + 2*I_M*L*L_M*M^2*R*l*phi_dota^2*cos(phia)*cos(thetaa)*sin(thetaa) + I_M*L^2*M*R*l*m_p*phi_dota^2*cos(phia)*cos(thetaa)*sin(thetaa) + L*L_M*M^2*R*l^3*m_p*phi_dota^2*cos(phia)^2*cos(thetaa)^2*sin(phia) + L*L_M^2*M^2*R*l^2*m_p*theta_dota^2*cos(phia)*cos(thetaa)^3*sin(phia) + L^2*L_M*M^2*R*l^2*m_p*theta_dota^2*cos(phia)*cos(thetaa)^3*sin(phia) + L*L_M*M*R*T_p*l*m_p*cos(thetaa)*sin(phia)*sin(thetaa) - L*L_M*M^2*R*g*l^2*m_p*cos(phia)*cos(thetaa)^2*sin(phia) - L*L_M*M^2*R*g*l^2*m_p*cos(phia)^2*cos(thetaa)*sin(thetaa) - L*L_M*M^2*R*g*l^2*m_p*cos(phia)*sin(phia)*sin(thetaa)^2 + L*L_M*M^2*R*g*l^2*m_p*cos(thetaa)*sin(phia)^2*sin(thetaa) - I_M*L*L_M*M*R*l*m_p*phi_dota^2*cos(thetaa)^2*sin(phia) + L*L_M^2*M^2*R*l^2*m_p*theta_dota^2*cos(phia)^2*cos(thetaa)^2*sin(thetaa) + 2*L^2*L_M*M^2*R*l^2*m_p*theta_dota^2*cos(phia)^2*cos(thetaa)^2*sin(thetaa) - L^2*L_M*M^2*R*l^2*m_p*theta_dota^2*cos(thetaa)^2*sin(phia)^2*sin(thetaa) + L^2*M^2*R*l^3*m_p*phi_dota^2*cos(phia)*cos(thetaa)*sin(phia)^2*sin(thetaa)...
    + L*L_M*M^2*R*l^3*m_p*phi_dota^2*cos(phia)^3*cos(thetaa)*sin(thetaa) + I_M*L*L_M*M*R*l*m_p*phi_dota^2*cos(phia)*cos(thetaa)*sin(thetaa) + L*L_M^2*M^2*R*l^2*m_p*theta_dota^2*cos(phia)*cos(thetaa)*sin(phia)*sin(thetaa)^2 + L^2*L_M*M^2*R*l^2*m_p*theta_dota^2*cos(phia)*cos(thetaa)*sin(phia)*sin(thetaa)^2 + L*L_M*M^2*R*l^3*m_p*phi_dota^2*cos(phia)*cos(thetaa)*sin(phia)^2*sin(thetaa)))/(I_M*I_p*I_w + I_M*I_p*R^2*m_p + I_M*I_p*R^2*m_w + I_M*I_p*M*R^2 - I_p*M^2*R^2*l^2*sin(phia)^2 + I_M*L^2*R^2*m_p^2*sin(thetaa)^2 + I_M*I_w*L^2*M*cos(thetaa)^2 + I_M*I_w*L_M^2*M*cos(thetaa)^2 + I_M*I_w*L^2*M*sin(thetaa)^2 + I_M*I_w*L_M^2*M*sin(thetaa)^2 + I_p*I_w*M*l^2*cos(phia)^2 + I_M*I_w*L^2*m_p*cos(thetaa)^2 - I_p*I_w*M*l^2*sin(phia)^2 + I_M*I_w*L^2*m_p*sin(thetaa)^2 + I_M*L^2*M^2*R^2*sin(thetaa)^2 + I_M*L_M^2*M^2*R^2*sin(thetaa)^2 + 2*I_M*L^2*M*R^2*m_p*sin(thetaa)^2 + I_M*L^2*M*R^2*m_w*sin(thetaa)^2 + I_M*L_M^2*M*R^2*m_p*sin(thetaa)^2 + I_M*L_M^2*M*R^2*m_w*sin(thetaa)^2 + 2*I_M*I_w*L*L_M*M*cos(thetaa)^2 + I_p*M*R^2*l^2*m_p*cos(phia)^2 + I_p*M*R^2*l^2*m_w*cos(phia)^2 + I_M*L^2*R^2*m_p*m_w*cos(thetaa)^2 + 2*I_M*I_w*L*L_M*M*sin(thetaa)^2 - I_p*M*R^2*l^2*m_p*sin(phia)^2 - I_p*M*R^2*l^2*m_w*sin(phia)^2 + I_M*L^2*R^2*m_p*m_w*sin(thetaa)^2 + I_w*L^2*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - I_w*L^2*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + I_w*L_M^2*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - I_w*L_M^2*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + 2*I_M*L*L_M*M^2*R^2*sin(thetaa)^2 + I_M*L^2*M*R^2*m_w*cos(thetaa)^2 + I_M*L_M^2*M*R^2*m_p*cos(thetaa)^2 + I_M*L_M^2*M*R^2*m_w*cos(thetaa)^2 ...
    + L^2*M*R^2*l^2*m_p^2*cos(phia)^2*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - L^2*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*R^2*l^2*m_p*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 - L^2*M*R^2*l^2*m_p^2*sin(phia)^2*sin(thetaa)^2 - L^2*M^2*R^2*l^2*m_p*sin(phia)^2*sin(thetaa)^2 + 2*I_w*L*L_M*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - 2*I_w*L*L_M*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + I_w*L^2*M*l^2*m_p*cos(phia)^2*cos(thetaa)^2 + ...
    I_w*L^2*M*l^2*m_p*cos(phia)^2*sin(thetaa)^2 - I_w*L^2*M*l^2*m_p*cos(thetaa)^2*sin(phia)^2 - I_w*L^2*M*l^2*m_p*sin(phia)^2*sin(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_w*cos(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_p*sin(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_w*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - 2*L*L_M*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 + L^2*M*R^2*l^2*m_p*m_w*cos(phia)^2*cos(thetaa)^2 + L^2*M*R^2*l^2*m_p*m_w*cos(phia)^2*sin(thetaa)^2 - L^2*M*R^2*l^2*m_p*m_w*cos(thetaa)^2*sin(phia)^2 - L^2*M*R^2*l^2*m_p*m_w*sin(phia)^2*sin(thetaa)^2);
%%
ddphi=(I_p*I_w*T_p + I_p*R^2*T_p*m_p + I_p*R^2*T_p*m_w + I_p*M*R^2*T_p + L^2*M^2*R^2*T_p*sin(thetaa)^2 + L_M^2*M^2*R^2*T_p*sin(thetaa)^2 + L^2*R^2*T_p*m_p^2*sin(thetaa)^2 + I_w*L^2*M*T_p*cos(thetaa)^2 + I_w*L_M^2*M*T_p*cos(thetaa)^2 + I_w*L^2*M*T_p*sin(thetaa)^2 + I_w*L_M^2*M*T_p*sin(thetaa)^2 + I_w*L^2*T_p*m_p*cos(thetaa)^2 + I_w*L^2*T_p*m_p*sin(thetaa)^2 + L^2*M*R^2*T_p*m_w*cos(thetaa)^2 + L_M^2*M*R^2*T_p*m_p*cos(thetaa)^2 + L_M^2*M*R^2*T_p*m_w*cos(thetaa)^2 + 2*L^2*M*R^2*T_p*m_p*sin(thetaa)^2 + L^2*M*R^2*T_p*m_w*sin(thetaa)^2 + L_M^2*M*R^2*T_p*m_p*sin(thetaa)^2 + L_M^2*M*R^2*T_p*m_w*sin(thetaa)^2 + 2*I_w*L*L_M*M*T_p*cos(thetaa)^2 + L^2*R^2*T_p*m_p*m_w*cos(thetaa)^2 + 2*I_w*L*L_M*M*T_p*sin(thetaa)^2 + L^2*R^2*T_p*m_p*m_w*sin(thetaa)^2 - I_p*M^2*R^2*g*l*sin(phia) - I_p*M*R*T*l*cos(phia) + 2*L*L_M*M^2*R^2*T_p*sin(thetaa)^2 - I_p*I_w*M*g*l*sin(phia) + I_p*M^2*R^2*l^2*phi_dota^2*cos(phia)*sin(phia) + I_w*L^3*M^2*l*theta_dota^2*cos(phia)*sin(thetaa)^3 + I_w*L^3*M^2*l*theta_dota^2*cos(thetaa)^3*sin(phia) + I_w*L_M^3*M^2*l*theta_dota^2*cos(phia)*sin(thetaa)^3 + I_w*L_M^3*M^2*l*theta_dota^2*cos(thetaa)^3*sin(phia) + 2*I_p*I_w*M*l^2*phi_dota^2*cos(phia)*sin(phia) - L*M^2*R^2*T*l*sin(phia)*sin(thetaa) - L_M*M^2*R^2*T*l*sin(phia)*sin(thetaa) + L*M^2*R^2*T_p*l*sin(phia)*sin(thetaa) + L_M*M^2*R^2*T_p*l*sin(phia)*sin(thetaa) + I_w*L*M*T*l*cos(phia)*cos(thetaa) + I_w*L_M*M*T*l*cos(phia)*cos(thetaa) - I_w*L*M*T_p*l*cos(phia)*cos(thetaa) - I_w*L_M*M*T_p*l*cos(phia)*cos(thetaa) - I_p*M*R^2*g*l*m_p*sin(phia) - I_p*M*R^2*g*l*m_w*sin(phia) - I_w*L*M*T*l*sin(phia)*sin(thetaa) - I_w*L_M*M*T*l*sin(phia)*sin(thetaa) + I_w*L*M*T_p*l*sin(phia)*sin(thetaa) + I_w*L_M*M*T_p*l*sin(phia)*sin(thetaa) - L^2*M^2*R*T*l*cos(phia)*sin(thetaa)^2 - L_M^2*M^2*R*T*l*cos(phia)*sin(thetaa)^2 - I_w*L^2*M^2*g*l*cos(thetaa)^2*sin(phia) - I_w*L_M^2*M^2*g*l*cos(thetaa)^2*sin(phia) + 2*L*L_M*M*R^2*T_p*m_w*cos(thetaa)^2 + 2*L*L_M*M*R^2*T_p*m_p*sin(thetaa)^2 + 2*L*L_M*M*R^2*T_p*m_w*sin(thetaa)^2 + L^3*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*sin(thetaa)^3 + L^3*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)^3*sin(phia) + L_M^3*M^2*R^2*l*m_p*theta_dota^2*cos(phia)*sin(thetaa)^3 + L_M^3*M^2*R^2*l*m_p*theta_dota^2*cos(thetaa)^3*sin(phia) + L_M^3*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*sin(thetaa)^3 + L_M^3*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)^3*sin(phia) + I_w*L^3*M^2*l*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + I_w*L_M^3*M^2*l*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + I_w*L^3*M^2*l*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + I_w*L_M^3*M^2*l*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + I_p*L*M^2*R^2*l*theta_dota^2*cos(thetaa)*sin(phia) + I_p*L_M*M^2*R^2*l*theta_dota^2*cos(thetaa)*sin(phia) - I_w*L^2*M^2*g*l*cos(phia)*cos(thetaa)*sin(thetaa) - I_w*L_M^2*M^2*g*l*cos(phia)*cos(thetaa)*sin(thetaa) + 2*I_p*M*R^2*l^2*m_p*phi_dota^2*cos(phia)*sin(phia) + 2*I_p*M*R^2*l^2*m_w*phi_dota^2*cos(phia)*sin(phia) + I_w*L^3*M*l*m_p*theta_dota^2*cos(phia)*sin(thetaa)^3 + I_w*L^3*M*l*m_p*theta_dota^2*cos(thetaa)^3*sin(phia) - L^2*M^2*R*T*l*cos(thetaa)*sin(phia)*sin(thetaa) - L_M^2*M^2*R*T*l*cos(thetaa)*sin(phia)*sin(thetaa) + L*M*R^2*T*l*m_w*cos(phia)*cos(thetaa) + L_M*M*R^2*T*l*m_p*cos(phia)*cos(thetaa) + L_M*M*R^2*T*l*m_w*cos(phia)*cos(thetaa) - L*M*R^2*T_p*l*m_w*cos(phia)*cos(thetaa) - L_M*M*R^2*T_p*l*m_p*cos(phia)*cos(thetaa) - L_M*M*R^2*T_p*l*m_w*cos(phia)*cos(thetaa) + I_p*I_w*L*M*l*theta_dota^2*cos(phia)*sin(thetaa) + I_p*I_w*L*M*l*theta_dota^2*cos(thetaa)*sin(phia) + I_p*I_w*L_M*M*l*theta_dota^2*cos(phia)*sin(thetaa) + I_p*I_w*L_M*M*l*theta_dota^2*cos(thetaa)*sin(phia) + I_w*L^2*M^2*l^2*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + I_w*L_M^2*M^2*l^2*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + I_w*L^2*M^2*l^2*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + I_w*L_M^2*M^2*l^2*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + I_w*L^2*M^2*l^2*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + I_w*L_M^2*M^2*l^2*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + I_w*L^2*M^2*l^2*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + I_w*L_M^2*M^2*l^2*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) - L*M*R^2*T*l*m_p*sin(phia)*sin(thetaa) - L*M*R^2*T*l*m_w*sin(phia)*sin(thetaa) - L_M*M*R^2*T*l*m_p*sin(phia)*sin(thetaa) - L_M*M*R^2*T*l*m_w*sin(phia)*sin(thetaa) + L*M*R^2*T_p*l*m_p*sin(phia)*sin(thetaa) + L*M*R^2*T_p*l*m_w*sin(phia)*sin(thetaa) + L_M*M*R^2*T_p*l*m_p*sin(phia)*sin(thetaa) + L_M*M*R^2*T_p*l*m_w*sin(phia)*sin(thetaa) + 3*I_w*L*L_M^2*M^2*l*theta_dota^2*cos(phia)*sin(thetaa)^3 + 3*I_w*L*L_M^2*M^2*l*theta_dota^2*cos(thetaa)^3*sin(phia) + 3*I_w*L^2*L_M*M^2*l*theta_dota^2*cos(phia)*sin(thetaa)^3 + 3*I_w*L^2*L_M*M^2*l*theta_dota^2*cos(thetaa)^3*sin(phia) - L^2*M^2*R^2*g*l*m_w*cos(thetaa)^2*sin(phia) - L_M^2*M^2*R^2*g*l*m_p*cos(thetaa)^2*sin(phia) - L_M^2*M^2*R^2*g*l*m_w*cos(thetaa)^2*sin(phia) - 2*L*L_M*M^2*R*T*l*cos(phia)*sin(thetaa)^2 - 2*I_w*L*L_M*M^2*g*l*cos(thetaa)^2*sin(phia) - L^2*M*R*T*l*m_p*cos(phia)*sin(thetaa)^2 - I_w*L^2*M*g*l*m_p*cos(thetaa)^2*sin(phia) + L^3*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L_M^3*M^2*R^2*l*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L_M^3*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L^3*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + L_M^3*M^2*R^2*l*m_p*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + L_M^3*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 - L^2*M^2*R^2*g*l*m_w*cos(phia)*cos(thetaa)*sin(thetaa) - L_M^2*M^2*R^2*g*l*m_p*cos(phia)*cos(thetaa)*sin(thetaa) - L_M^2*M^2*R^2*g*l*m_w*cos(phia)*cos(thetaa)*sin(thetaa) + L^3*M*R^2*l*m_p*m_w*theta_dota^2*cos(phia)*sin(thetaa)^3 + L^3*M*R^2*l*m_p*m_w*theta_dota^2*cos(thetaa)^3*sin(phia) + I_w*L^3*M*l*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + I_w*L^3*M*l*m_p*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 - 2*I_w*L*L_M*M^2*g*l*cos(phia)*cos(thetaa)*sin(thetaa) - 2*L*L_M*M^2*R*T*l*cos(thetaa)*sin(phia)*sin(thetaa) + I_p*L*M*R^2*l*m_p*theta_dota^2*cos(thetaa)*sin(phia) + I_p*L*M*R^2*l*m_w*theta_dota^2*cos(phia)*sin(thetaa) + I_p*L*M*R^2*l*m_w*theta_dota^2*cos(thetaa)*sin(phia) + I_p*L_M*M*R^2*l*m_p*theta_dota^2*cos(phia)*sin(thetaa) + I_p*L_M*M*R^2*l*m_p*theta_dota^2*cos(thetaa)*sin(phia) + I_p*L_M*M*R^2*l*m_w*theta_dota^2*cos(phia)*sin(thetaa) + I_p*L_M*M*R^2*l*m_w*theta_dota^2*cos(thetaa)*sin(phia) + L^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L_M^2*M^2*R^2*l^2*m_p*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L_M^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_p*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + 2*L^2*M*R^2*l^2*m_p^2*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + 2*L^2*M^2*R^2*l^2*m_p*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L_M^2*M^2*R^2*l^2*m_p*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L_M^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_p*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + L_M^2*M^2*R^2*l^2*m_w*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) - I_w*L^2*M*g*l*m_p*cos(phia)*cos(thetaa)*sin(thetaa) + 2*I_w*L*L_M*M^2*l^2*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) - L^2*M*R*T*l*m_p*cos(thetaa)*sin(phia)*sin(thetaa) + 2*I_w*L*L_M*M^2*l^2*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + 2*L*L_M^2*M^2*R^2*l*m_p*theta_dota^2*cos(phia)*sin(thetaa)^3 + L*L_M^2*M^2*R^2*l*m_p*theta_dota^2*cos(thetaa)^3*sin(phia) + L^2*L_M*M*R^2*l*m_p^2*theta_dota^2*cos(phia)*sin(thetaa)^3 + L^2*L_M*M^2*R^2*l*m_p*theta_dota^2*cos(phia)*sin(thetaa)^3 + 3*L*L_M^2*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*sin(thetaa)^3 + 3*L*L_M^2*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)^3*sin(phia) + 3*L^2*L_M*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*sin(thetaa)^3 + 3*L^2*L_M*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)^3*sin(phia) + 3*I_w*L*L_M^2*M^2*l*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + 3*I_w*L^2*L_M*M^2*l*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + 2*I_w*L*L_M*M^2*l^2*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + 2*I_w*L*L_M*M^2*l^2*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + 3*I_w*L*L_M^2*M^2*l*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + 3*I_w*L^2*L_M*M^2*l*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + 2*I_w*L^2*M*l^2*m_p*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + 2*I_w*L^2*M*l^2*m_p*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 - 2*L*L_M*M^2*R^2*g*l*m_w*cos(thetaa)^2*sin(phia) + I_w*L^2*L_M*M*l*m_p*theta_dota^2*cos(phia)*sin(thetaa)^3 + I_w*L^2*L_M*M*l*m_p*theta_dota^2*cos(thetaa)^3*sin(phia) + L*L_M*M*R^2*g*l*m_p^2*sin(phia)*sin(thetaa)^2 + L*L_M*M^2*R^2*g*l*m_p*sin(phia)*sin(thetaa)^2 + L*L_M*M*R*T*l*m_p*cos(phia)*cos(thetaa)^2 - L^2*M*R^2*g*l*m_p*m_w*cos(thetaa)^2*sin(phia) + I_w*L*L_M*M*g*l*m_p*sin(phia)*sin(thetaa)^2 + L^3*M*R^2*l*m_p*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L^3*M*R^2*l*m_p*m_w*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 - L*L_M*M*R^2*g*l*m_p^2*cos(phia)*cos(thetaa)*sin(thetaa) - L*L_M*M^2*R^2*g*l*m_p*cos(phia)*cos(thetaa)*sin(thetaa) - 2*L*L_M*M^2*R^2*g*l*m_w*cos(phia)*cos(thetaa)*sin(thetaa) - L^2*M*R^2*g*l*m_p*m_w*cos(phia)*cos(thetaa)*sin(thetaa) + 2*L*L_M*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + L*L_M*M^2*R^2*l^2*m_p*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + 2*L*L_M*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)^2*cos(thetaa)*sin(thetaa) + 2*L*L_M^2*M^2*R^2*l*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L^2*L_M*M*R^2*l*m_p^2*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L^2*L_M*M^2*R^2*l*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + 3*L*L_M^2*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + 3*L^2*L_M*M^2*R^2*l*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + 2*L*L_M*M^2*R^2*l^2*m_p*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_w*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L*L_M*M^2*R^2*l^2*m_p*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) + 2*L*L_M*M^2*R^2*l^2*m_w*phi_dota^2*cos(thetaa)*sin(phia)^2*sin(thetaa) - I_w*L*L_M*M*g*l*m_p*cos(phia)*cos(thetaa)*sin(thetaa) + L*L_M^2*M^2*R^2*l*m_p*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + 3*L*L_M^2*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + 3*L^2*L_M*M^2*R^2*l*m_w*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 - L*L_M*M*R*T*l*m_p*cos(thetaa)*sin(phia)*sin(thetaa) + 2*L^2*M*R^2*l^2*m_p*m_w*phi_dota^2*cos(phia)*cos(thetaa)^2*sin(phia) + 2*L^2*M*R^2*l^2*m_p*m_w*phi_dota^2*cos(phia)*sin(phia)*sin(thetaa)^2 + L^2*L_M*M*R^2*l*m_p*m_w*theta_dota^2*cos(phia)*sin(thetaa)^3 + L^2*L_M*M*R^2*l*m_p*m_w*theta_dota^2*cos(thetaa)^3*sin(phia) + I_w*L^2*L_M*M*l*m_p*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + I_w*L^2*L_M*M*l*m_p*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2 + L*L_M*M*R^2*g*l*m_p*m_w*sin(phia)*sin(thetaa)^2 - L*L_M*M*R^2*g*l*m_p*m_w*cos(phia)*cos(thetaa)*sin(thetaa) + L^2*L_M*M*R^2*l*m_p*m_w*theta_dota^2*cos(phia)*cos(thetaa)^2*sin(thetaa) + L^2*L_M*M*R^2*l*m_p*m_w*theta_dota^2*cos(thetaa)*sin(phia)*sin(thetaa)^2)/(I_M*I_p*I_w + I_M*I_p*R^2*m_p + I_M*I_p*R^2*m_w + I_M*I_p*M*R^2 - I_p*M^2*R^2*l^2*sin(phia)^2 + I_M*L^2*R^2*m_p^2*sin(thetaa)^2 + I_M*I_w*L^2*M*cos(thetaa)^2 + I_M*I_w*L_M^2*M*cos(thetaa)^2 + I_M*I_w*L^2*M*sin(thetaa)^2 + I_M*I_w*L_M^2*M*sin(thetaa)^2 + I_p*I_w*M*l^2*cos(phia)^2 + I_M*I_w*L^2*m_p*cos(thetaa)^2 - I_p*I_w*M*l^2*sin(phia)^2 + I_M*I_w*L^2*m_p*sin(thetaa)^2 + I_M*L^2*M^2*R^2*sin(thetaa)^2 + I_M*L_M^2*M^2*R^2*sin(thetaa)^2 + 2*I_M*L^2*M*R^2*m_p*sin(thetaa)^2 + I_M*L^2*M*R^2*m_w*sin(thetaa)^2 + I_M*L_M^2*M*R^2*m_p*sin(thetaa)^2 + I_M*L_M^2*M*R^2*m_w*sin(thetaa)^2 + 2*I_M*I_w*L*L_M*M*cos(thetaa)^2 + I_p*M*R^2*l^2*m_p*cos(phia)^2 + I_p*M*R^2*l^2*m_w*cos(phia)^2 + I_M*L^2*R^2*m_p*m_w*cos(thetaa)^2 + 2*I_M*I_w*L*L_M*M*sin(thetaa)^2 - I_p*M*R^2*l^2*m_p*sin(phia)^2 - I_p*M*R^2*l^2*m_w*sin(phia)^2 + I_M*L^2*R^2*m_p*m_w*sin(thetaa)^2 + I_w*L^2*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - I_w*L^2*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + I_w*L_M^2*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - I_w*L_M^2*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + 2*I_M*L*L_M*M^2*R^2*sin(thetaa)^2 + I_M*L^2*M*R^2*m_w*cos(thetaa)^2 + I_M*L_M^2*M*R^2*m_p*cos(thetaa)^2 + I_M*L_M^2*M*R^2*m_w*cos(thetaa)^2 + L^2*M*R^2*l^2*m_p^2*cos(phia)^2*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 + L^2*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - L^2*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*R^2*l^2*m_p*cos(thetaa)^2*sin(phia)^2 + L_M^2*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - L_M^2*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 - L^2*M*R^2*l^2*m_p^2*sin(phia)^2*sin(thetaa)^2 - L^2*M^2*R^2*l^2*m_p*sin(phia)^2*sin(thetaa)^2 + 2*I_w*L*L_M*M^2*l^2*cos(phia)^2*sin(thetaa)^2 - 2*I_w*L*L_M*M^2*l^2*cos(thetaa)^2*sin(phia)^2 + I_w*L^2*M*l^2*m_p*cos(phia)^2*cos(thetaa)^2 + I_w*L^2*M*l^2*m_p*cos(phia)^2*sin(thetaa)^2 - I_w*L^2*M*l^2*m_p*cos(thetaa)^2*sin(phia)^2 - I_w*L^2*M*l^2*m_p*sin(phia)^2*sin(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_w*cos(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_p*sin(thetaa)^2 + 2*I_M*L*L_M*M*R^2*m_w*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_p*cos(phia)^2*sin(thetaa)^2 + 2*L*L_M*M^2*R^2*l^2*m_w*cos(phia)^2*sin(thetaa)^2 - 2*L*L_M*M^2*R^2*l^2*m_w*cos(thetaa)^2*sin(phia)^2 + L^2*M*R^2*l^2*m_p*m_w*cos(phia)^2*cos(thetaa)^2 + L^2*M*R^2*l^2*m_p*m_w*cos(phia)^2*sin(thetaa)^2 - L^2*M*R^2*l^2*m_p*m_w*cos(thetaa)^2*sin(phia)^2 - L^2*M*R^2*l^2*m_p*m_w*sin(phia)^2*sin(thetaa)^2);
%%



DX=[theta_dota,ddth,x_dota,ddx,phi_dota,ddphi]';
end

function U = control_LQR(X,K)

% K=[-518.630952756606,-163.865462396828,-0.918278733001755,-3.02651334530555,83.2139675667216,19.0724987540786;-107.009642498362,-33.8105176313671,-0.395934550794602,-1.16875605176547,95.7004883416066,22.1728131144323];
U=-(K*X);
end
